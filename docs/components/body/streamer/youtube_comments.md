# YouTube コメント取得モジュール

YouTube のライブチャットからリアルタイムにコメントを取得するためのモジュール群です。効率的なポーリングとメインプロセスの保護のために分離された設計になっています。

## 構成モジュール

### 1. `fetch_comments.py` (サブプロセス)
YouTube API を叩き続ける「作業員」です。
- **特徴**: OAuth トークンを使用して API を呼び出し、新しいコメントを見つけたら標準出力に JSON 形式で出力します。
- **API 最適化**: YouTube が推奨するポーリング間隔 (`pollingIntervalMillis`) を動的に取得し、API 制限にかからないよう自動調節します。

### 2. `youtube_comment_adapter.py` (アダプタークラス)
上記サブプロセスを管理する「マネージャー」です。
- **管理**: `StreamerBodyService` から利用され、裏側で `fetch_comments.py` を起動・監視します。
- **非同期処理**: 標準出力から流れてくるコメントを別スレッドで読み取り、キューに溜め込みます。
- **インターフェース**: `get()` メソッドが呼ばれると、それまでに溜まったコメントを安全に返却します。
- **整合性**: `StreamerBodyService` 内でインスタンスとして保持され、配信中に一貫して同じサブプロセスと通信します。

## 設定 (環境変数)
| 変数名 | 説明 |
| :--- | :--- |
| `YOUTUBE_TOKEN_JSON` | `fetch_comments.py` が使用する OAuth 認証情報 (JSON 文字列) |
| `YOUTUBE_POLLING_INTERVAL` | デフォルトの取得間隔（秒） |

## データの流れ
1. アダプターがサブプロセスを起動。
2. サブプロセスが YouTube API を呼び出し、コメントを取得。
3. コメントが標準出力経由でアダプターのスレッドに届く。
4. `SaintGraph` 等からのリクエストに応じて、アダプターが溜まっていたコメントをまとめて返す。

## なぜサブプロセスに分けているのか？
YouTube API のポーリングは、通信待ちやレート制限のリトライなどで処理が一時停止することがあります。これをメインの Body サービス内で行うと、音声の再生や OBS 制御まで止まってしまうため、別プロセスに分離して並行動作させています。
