# YouTube コメント取得モジュール

YouTube のライブチャットからリアルタイムにコメントを取得するためのモジュール群です。効率的なポーリングとメインプロセスの保護のために分離された設計になっています。

## 構成モジュール

### 1. `youtube_comment_fetcher.py` (サブプロセス)
YouTube API を叩き続ける「作業員」です。
- **特徴**: OAuth トークンを使用して API を呼び出し、新しいコメントを見つけたら標準出力に JSON 形式で出力します。
- **API 最適化**: YouTube が推奨するポーリング間隔 (`pollingIntervalMillis`) を動的に取得し、API 制限にかからないよう自動調節します。

### 2. `youtube_comment_adapter.py` (アダプタークラス)
上記サブプロセスを管理する「マネージャー」です。
- **管理**: `StreamerBodyService` から利用され、裏側で `youtube_comment_fetcher.py` を起動・監視します。
- **非同期処理**: 標準出力から流れてくるコメントを別スレッドで読み取り、キューに溜め込みます。
- **インターフェース**: `get()` メソッドが呼ばれると、それまでに溜まったコメントを安全に返却します。
- **整合性**: `StreamerBodyService` 内でインスタンスとして保持され、配信中に一貫して同じサブプロセスと通信します。

## 設定 (環境変数)
| 変数名 | 説明 |
| :--- | :--- |
| `YOUTUBE_TOKEN_JSON` | `youtube_comment_fetcher.py` が使用する OAuth 認証情報 (JSON 文字列) |
| `YOUTUBE_POLLING_INTERVAL` | デフォルトの取得間隔（秒） |

## データの流れ
1. アダプターがサブプロセスを起動。
2. サブプロセスが YouTube API を呼び出し、コメントを取得。
3. コメントが標準出力経由でアダプターのスレッドに届く。
4. `SaintGraph` 等からのリクエストに応じて、アダプターが溜まっていたコメントをまとめて返す。

## なぜサブプロセスに分けているのか？
YouTube API のポーリングは、通信待ちやレート制限のリトライなどで処理が一時停止することがあります。これをメインの Body サービス内で行うと、音声の再生や OBS 制御まで止まってしまう（メインループをブロックしてしまう）ため、別プロセスに分離して並行動作させています。

## 設計思想と命名の理由：インターフェースと実装の分離

本プロジェクトでは、上位モジュール（サービスクラス）から直接呼び出される窓口を「アダプター」と呼び、実際の外部通信を行うスクリプトを「フェッチャー（実装詳細）」と定義しています。

1. **インターフェースとしての `youtube_comment_adapter.py`**
   - サービスクラスに対し「コメントを取得する」という抽象的な機能を提供します。
   - 裏側で「サブプロセスを起動する」という具体的な**手段（実装方針）を選択する責務**を負います。
2. **実装詳細としての `youtube_comment_fetcher.py`**
   - アダプターに選ばれた「実行パーツ」です。
   - YouTube API との物理的なやり取りに特化し、標準入出力という疎結合な手段でアダプターにデータを届けます。

この分離により、将来的に取得ロジックを非同期ライブラリ等に変更する場合でも、サービスクラスは影響を受けず、アダプター内の「手段」を差し替えるだけで済む柔軟性を確保しています。
